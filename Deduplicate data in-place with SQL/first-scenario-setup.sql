-- Code developed on MySQL 8.0.31.
-- If using the provided mysql docker compose, you can use root/root on localhost:3306

-- Setup
CREATE DATABASE IF NOT EXISTS ARTICLE;
USE ARTICLE;
DROP TABLE IF EXISTS FACT_SALES_SK;

CREATE TABLE IF NOT EXISTS FACT_SALES_SK(
SK INT KEY AUTO_INCREMENT,
PRODUCT_SK INT,
CLIENT_SK INT,
QUANTITY INT,
AMOUNT FLOAT,
TOTAL_AMOUNT FLOAT,
SALES_DATETIME DATETIME
);

INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (1,1,1,2.99,2.99,'2023-01-15 10:10:11');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,2,3,5.79,5.79*3,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');
INSERT INTO FACT_SALES_SK (PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME) VALUES (2,3,7,11.99,11.99*7,'2023-01-16 18:56:02');

SELECT * FROM FACT_SALES_SK;

-- Delete duplicates based on max(sk) - Idempotent
with FACT_SALES_SK_DELETE as
(
SELECT MAX(SK) MAX_SK, COUNT(SK) COUNT_SK, PRODUCT_SK,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME from FACT_SALES_SK group by PRODUCT_SK ,CLIENT_SK,QUANTITY,AMOUNT,TOTAL_AMOUNT,SALES_DATETIME HAVING COUNT(SK) > 1
)
delete FS from FACT_SALES_SK FS inner join FACT_SALES_SK_DELETE FSD
on FS.PRODUCT_SK =FSD.PRODUCT_SK AND FS.CLIENT_SK = FSD.CLIENT_SK AND FS.QUANTITY = FSD.QUANTITY AND FS.AMOUNT =FSD.AMOUNT AND FS.TOTAL_AMOUNT = FSD.TOTAL_AMOUNT
where FS.SK != FSD.MAX_SK;

SELECT * FROM FACT_SALES_SK;


